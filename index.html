<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dots & Dice - Custom Background</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    /* --- BASIC SETUP & BACKGROUND --- */
    body, html { 
      height: 100%; margin: 0; 
      font-family: 'Segoe UI', sans-serif; 
      overflow: hidden; overscroll-behavior: none;

      /* ðŸ‘‡ YAHAN AFNO PHOTO KO LINK HALNU ðŸ‘‡ */
      background-image: url('https://cdn.discordapp.com/attachments/1420003318096461825/1465701832948060356/att.3CUk4_pCKFMmxIuacZHQ3djMXO55ZSYpGbEwLgnd-7s.jpg?ex=697a10b4&is=6978bf34&hm=e2d37a26291db6fcbf7a153f5250cab31ee8d4c5a8f6e9fa25f2cab1efe569e4&'); 
      
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    #game-container { 
      width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
      z-index: 1; touch-action: none; 
      
      /* ðŸ‘‡ BOARD KO PACHADI PHOTO DEKHAUNA LAI YO LINE RAKHEKO */
      /* 0.85 = Board ali seto hunxa (Clear game). 0.5 banayau vane photo dherai dekhinxa */
      background: rgba(255, 255, 255, 0.85); 
    }
    
    .ui-panel { position: absolute; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; text-align: center; width: 85%; max-width: 350px; left: 50%; top: 50%; transform: translate(-50%, -50%); }

    /* 3D DICE SCENE */
    #dice-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; perspective: 1000px; }
    .cube { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
    .cube.rolling { animation: spinDice 0.6s linear infinite; }
    
    /* DICE FACE TEXTURE SUPPORT */
    .face { 
      position: absolute; width: 100px; height: 100px; 
      background-color: white; 
      border: 2px solid #ccc; border-radius: 10px; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 40px; font-weight: bold; color: #333; 
      box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
    }
    .face.front  { transform: rotateY(0deg) translateZ(50px); }
    .face.back   { transform: rotateY(180deg) translateZ(50px); }
    .face.right  { transform: rotateY(90deg) translateZ(50px); }
    .face.left   { transform: rotateY(-90deg) translateZ(50px); }
    .face.top    { transform: rotateX(90deg) translateZ(50px); }
    .face.bottom { transform: rotateX(-90deg) translateZ(50px); }
    .dot-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 70%; height: 70%; }
    .d-dot { background: #333; border-radius: 50%; width: 12px; height: 12px; margin: auto; }
    
    @keyframes spinDice { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
    .show-1 { transform: rotateX(0deg) rotateY(0deg); }
    .show-6 { transform: rotateX(180deg) rotateY(0deg); }
    .show-2 { transform: rotateY(-90deg); }
    .show-5 { transform: rotateY(90deg); }
    .show-3 { transform: rotateX(-90deg); }
    .show-4 { transform: rotateX(90deg); }

    /* UI BARS */
    .top-bar { position: absolute; top: 0; left: 0; right: 0; height: 80px; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .bottom-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 90px; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: space-around; z-index: 500; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); }
    
    input, select { padding: 12px; margin: 8px 0; width: 90%; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 12px; background: #2f7bff; color: white; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
    button:disabled { background: #ccc; }
    .hidden { display: none !important; }
    #waitingOverlay, #gameOverOverlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); color: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .score-item { display: flex; flex-direction: column; align-items: center; font-size: 14px; }
    .score-dot { width: 10px; height: 10px; border-radius: 50%; margin-bottom: 2px; }
  </style>
</head>
<body>

  <div id="dice-scene"><div class="cube" id="diceCube">
    <div class="face front"><div class="dot-grid"><div style="grid-area:2/2" class="d-dot"></div></div></div>
    <div class="face back"><div class="dot-grid"><div style="grid-area:1/1" class="d-dot"></div><div style="grid-area:1/3" class="d-dot"></div><div style="grid-area:2/1" class="d-dot"></div><div style="grid-area:2/3" class="d-dot"></div><div style="grid-area:3/1" class="d-dot"></div><div style="grid-area:3/3" class="d-dot"></div></div></div>
    <div class="face right"><div class="dot-grid"><div style="grid-area:1/3" class="d-dot"></div><div style="grid-area:3/1" class="d-dot"></div></div></div>
    <div class="face left"><div class="dot-grid"><div style="grid-area:1/1" class="d-dot"></div><div style="grid-area:1/3" class="d-dot"></div><div style="grid-area:2/2" class="d-dot"></div><div style="grid-area:3/1" class="d-dot"></div><div style="grid-area:3/3" class="d-dot"></div></div></div>
    <div class="face top"><div class="dot-grid"><div style="grid-area:1/1" class="d-dot"></div><div style="grid-area:2/2" class="d-dot"></div><div style="grid-area:3/3" class="d-dot"></div></div></div>
    <div class="face bottom"><div class="dot-grid"><div style="grid-area:1/1" class="d-dot"></div><div style="grid-area:1/3" class="d-dot"></div><div style="grid-area:3/1" class="d-dot"></div><div style="grid-area:3/3" class="d-dot"></div></div></div>
  </div></div>

  <div id="game-container"></div>

  <div id="waitingOverlay" class="hidden">
    <h2>Room Ready!</h2>
    <h1 id="shareCode" style="color: #4eff4e; font-size: 40px;">---</h1>
    <p id="waitText">Waiting for players...</p>
    <button id="cancelWaitBtn" style="width: auto; background: #555;">Exit</button>
  </div>

  <div id="gameOverOverlay" class="hidden">
    <h1 style="color: gold;">GAME OVER</h1>
    <h2 id="winnerText">---</h2>
    <div id="finalScores"></div>
    <button id="leaveGameBtn" style="width: 150px; background: #dc3545; margin-top: 10px;">LEAVE</button>
  </div>

  <div id="lobbyUI" class="ui-panel">
    <h2>Dots & Dice</h2>
    <input id="displayName" placeholder="Nickname" maxlength="10" />
    <input id="roomInput" placeholder="Room Code" />
    <select id="gameMode"><option value="lucky">Lucky Mode</option><option value="classic">Classic</option></select>
    <select id="maxPlayers"><option value="2">2 Players</option><option value="4">4 Players</option></select>
    <button id="createRoomBtn">CREATE ROOM</button>
    <button id="joinRoomBtn" style="background: #28a745; margin-top: 8px;">JOIN ROOM</button>
  </div>

  <div id="gameUI_Top" class="top-bar hidden">
    <div id="roomLabel" style="font-weight:bold;">---</div>
    <div id="turnLabel" style="padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight:bold;">Waiting...</div>
    <div id="scoreContainer" style="display:flex; gap:10px;"></div>
  </div>

  <div id="gameUI_Bottom" class="bottom-bar hidden">
    <button id="rollBtn" style="width: 60%;">ROLL DICE</button>
    <div style="text-align:center;"><div style="font-size:10px;">LINES</div><b id="linesLeft" style="font-size:20px;">0</b></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCwy91uqMBAM_kXfxd8bE6LsVOXdNL54i8",
    authDomain: "dotgame-4a8df.firebaseapp.com",
    databaseURL: "https://dotgame-4a8df-default-rtdb.firebaseio.com",
    projectId: "dotgame-4a8df",
    storageBucket: "dotgame-4a8df.firebasestorage.app",
    messagingSenderId: "420421686536",
    appId: "1:420421686536:web:ac66a3a4a75aff31c908bd"
  };

  firebase.initializeApp(FIREBASE_CONFIG);
  const db = firebase.database();
  const auth = firebase.auth();
  let myUid, currentRoom, roomData, gameInstance;
  let lastProcessedRoll = 0;
  let localRolling = false; 

  const PLAYER_CONFIG = [
    { hex: 0xff4444, css: '#ff4444' }, { hex: 0x2f7bff, css: '#2f7bff' },
    { hex: 0x00cc00, css: '#00cc00' }, { hex: 0xffbb00, css: '#ffbb00' }
  ];

  // SOUNDS
  const sndRoll = new Audio('https://www.soundjay.com/board-games/sounds/dice-roll-1.mp3');
  const sndLine = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
  const sndBoom = new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3'); 
  const sndLucky = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'); 

  auth.signInAnonymously().then(u => myUid = u.user.uid);

  // --- ACTIONS ---
  document.getElementById('createRoomBtn').onclick = async () => {
    const code = document.getElementById('roomInput').value.toUpperCase();
    const name = document.getElementById('displayName').value || 'Host';
    if(!code) return alert("Enter Code");
    
    await db.ref('rooms/'+code).set({
      config: { maxPlayers: parseInt(document.getElementById('maxPlayers').value), rows: 5, cols: 5, mode: document.getElementById('gameMode').value },
      players: { [myUid]: { name, colorIdx: 0, score: 0 } },
      state: 'waiting', lastActive: Date.now(), dice: { rem: 0 }, latestRoll: { val: 0, ts: 0 },
      edges: {}, boxes: {}, specialBoxes: generateSpecials(5, 5)
    });
    enterRoom(code);
  };

  document.getElementById('joinRoomBtn').onclick = async () => {
    const code = document.getElementById('roomInput').value.toUpperCase();
    const name = document.getElementById('displayName').value || 'Player';
    const snap = await db.ref('rooms/'+code).once('value');
    if(!snap.exists()) return alert("No Room");
    const r = snap.val();
    const pCount = Object.keys(r.players||{}).length;
    
    await db.ref(`rooms/${code}/players/${myUid}`).set({ name, colorIdx: pCount, score: 0 });
    if(pCount + 1 >= r.config.maxPlayers) {
      await db.ref(`rooms/${code}`).update({ state: 'playing', turnOrder: Object.keys(r.players).concat(myUid), turnIndex: 0 });
    }
    enterRoom(code);
  };

  function generateSpecials(r, c) {
    let s = {}; let coords = [];
    for(let i=0; i<r; i++) for(let j=0; j<c; j++) coords.push(`${i}_${j}`);
    coords.sort(() => Math.random() - 0.5);
    s[coords[0]] = 'bonus'; s[coords[1]] = 'bonus'; s[coords[2]] = 'boom';
    return s;
  }

  function enterRoom(code) {
    currentRoom = code;
    document.getElementById('lobbyUI').classList.add('hidden');
    document.getElementById('roomLabel').innerText = code;
    
    db.ref('rooms/' + code).on('value', snap => {
      roomData = snap.val();
      if(!roomData) return;

      if(roomData.latestRoll && roomData.latestRoll.ts > lastProcessedRoll) {
        lastProcessedRoll = roomData.latestRoll.ts;
        showDiceAnim(roomData.latestRoll.val);
      }
      
      updateUI();
      if(gameInstance) gameInstance.scene.getScene('GameScene').drawBoard();
    });
    if(!gameInstance) initPhaser();
  }

  function showDiceAnim(val) {
    localRolling = true;
    updateUI(); 
    const scene = document.getElementById('dice-scene');
    const cube = document.getElementById('diceCube');
    scene.style.display = 'flex';
    sndRoll.play().catch(()=>{});
    cube.className = 'cube rolling';

    setTimeout(() => {
      cube.className = 'cube show-' + val;
      setTimeout(() => {
        scene.style.display = 'none';
        localRolling = false; 
        updateUI();
      }, 1000);
    }, 800);
  }

  function updateUI() {
    if(!roomData) return;
    const isMe = roomData.turnOrder && roomData.turnOrder[roomData.turnIndex] === myUid;
    
    document.getElementById('waitingOverlay').classList.toggle('hidden', roomData.state !== 'waiting');
    document.getElementById('shareCode').innerText = currentRoom;

    document.getElementById('gameUI_Top').classList.toggle('hidden', roomData.state === 'waiting');
    document.getElementById('gameUI_Bottom').classList.toggle('hidden', roomData.state === 'waiting');

    const turnLbl = document.getElementById('turnLabel');
    if(roomData.state === 'playing') {
      const p = roomData.players[roomData.turnOrder[roomData.turnIndex]];
      turnLbl.innerText = isMe ? "YOUR TURN" : `${p.name}'S TURN`;
      turnLbl.style.background = PLAYER_CONFIG[p.colorIdx].css;
      turnLbl.style.color = "white";
    }

    const linesEl = document.getElementById('linesLeft');
    if(localRolling) {
      linesEl.innerText = "ðŸŽ²";
    } else {
      linesEl.innerText = roomData.dice.rem || 0;
    }

    const rollBtn = document.getElementById('rollBtn');
    rollBtn.disabled = !isMe || roomData.dice.rem > 0 || localRolling;
    rollBtn.innerText = localRolling ? "ROLLING..." : (roomData.dice.rem > 0 ? "DRAW LINES" : "ROLL DICE");
  }

  document.getElementById('rollBtn').onclick = () => {
    const val = Math.floor(Math.random() * 6) + 1;
    db.ref(`rooms/${currentRoom}`).update({
      dice: { val: val, rem: val },
      latestRoll: { val: val, ts: Date.now() }
    });
  };

  function initPhaser() {
    gameInstance = new Phaser.Game({
      type: Phaser.AUTO, parent: 'game-container', width: window.innerWidth, height: window.innerHeight, transparent: true,
      scene: GameScene, scale: { mode: Phaser.Scale.RESIZE }
    });
  }

  class GameScene extends Phaser.Scene {
    create() { this.graphics = this.add.graphics(); this.drawBoard(); }
    drawBoard() {
      if(!roomData) return;
      this.graphics.clear();
      const { rows, cols } = roomData.config;
      const cellSize = Math.min((this.scale.width-40)/cols, (this.scale.height-200)/rows);
      const offX = (this.scale.width - cols*cellSize)/2;
      const offY = 100;

      // Draw Boxes
      for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
          const key = `${r}_${c}`;
          if(roomData.boxes[key] !== undefined) {
            const pc = PLAYER_CONFIG[roomData.boxes[key]];
            this.graphics.fillStyle(pc.hex, 0.4); // slightly more opaque for custom bg
            this.graphics.fillRect(offX + c*cellSize, offY + r*cellSize, cellSize, cellSize);
            if(roomData.specialBoxes[key]) {
              const icon = roomData.specialBoxes[key] === 'bonus' ? 'â­' : 'ðŸ’£';
              this.add.text(offX + c*cellSize + cellSize/2, offY + r*cellSize + cellSize/2, icon).setOrigin(0.5);
            }
          }
        }
      }

      // Draw Edges
      for(let r=0; r<=rows; r++) {
        for(let c=0; c<=cols; c++) {
          const x = offX + c*cellSize; const y = offY + r*cellSize;
          if(c < cols) {
            const id = `h_${r}_${c}`;
            const taken = roomData.edges[id];
            this.graphics.lineStyle(4, taken ? PLAYER_CONFIG[taken.cIdx].hex : 0xbbbbbb); // slightly darker grey
            this.graphics.lineBetween(x, y, x+cellSize, y);
            if(!taken) {
              let zone = this.add.rectangle(x+cellSize/2, y, cellSize, 20, 0, 0).setInteractive();
              zone.on('pointerdown', () => this.claim(id));
            }
          }
          if(r < rows) {
            const id = `v_${r}_${c}`;
            const taken = roomData.edges[id];
            this.graphics.lineStyle(4, taken ? PLAYER_CONFIG[taken.cIdx].hex : 0xbbbbbb);
            this.graphics.lineBetween(x, y, x, y+cellSize);
            if(!taken) {
              let zone = this.add.rectangle(x, y+cellSize/2, 20, cellSize, 0, 0).setInteractive();
              zone.on('pointerdown', () => this.claim(id));
            }
          }
          this.graphics.fillStyle(0x333333); this.graphics.fillCircle(x, y, 4);
        }
      }
    }

    claim(id) {
      if(localRolling || roomData.dice.rem <= 0) return;
      if(roomData.turnOrder[roomData.turnIndex] !== myUid) return;

      db.ref(`rooms/${currentRoom}`).transaction(r => {
        if(!r || r.edges[id]) return;
        const myP = r.players[myUid];
        r.edges[id] = { cIdx: myP.colorIdx };
        r.dice.rem--;

        let boxesMade = 0;
        const check = (row, col) => {
          if(row<0 || col<0 || row>=r.config.rows || col>=r.config.cols) return;
          if(r.boxes[`${row}_${col}`] !== undefined) return;
          if(r.edges[`h_${row}_${col}`] && r.edges[`h_${row+1}_${col}`] && r.edges[`v_${row}_${col}`] && r.edges[`v_${row}_${col+1}`]) {
            r.boxes[`${row}_${col}`] = myP.colorIdx;
            let pts = 1;
            if(r.specialBoxes[`${row}_${col}`] === 'bonus') { pts = 3; sndLucky.play(); }
            if(r.specialBoxes[`${row}_${col}`] === 'boom') { r.dice.rem = 0; sndBoom.play(); }
            myP.score += pts; boxesMade++;
          }
        };
        const p = id.split('_'); const rr = parseInt(p[1]); const cc = parseInt(p[2]);
        if(p[0]==='h') { check(rr, cc); check(rr-1, cc); } else { check(rr, cc); check(rr, cc-1); }

        if(r.dice.rem <= 0) r.turnIndex = (r.turnIndex + 1) % r.turnOrder.length;
        return r;
      }).then(() => sndLine.play());
    }
  }
  </script>
</body>
</html>
